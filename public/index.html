<!doctype html>
<html>
<head>
    <title>Music streaming thing</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700">
    <link href='//fonts.googleapis.com/css?family=Roboto:400,100,300,100italic,300italic,900italic,900,700italic,700,500italic,500,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/bootstrap-social-icons.css">
    <link type="text/css" href="css/font-awesome.min.css" rel="stylesheet" />
    <link type="text/css" href="css/styles.css" rel="stylesheet" />
    <link type="text/css" href="css/jquery.fullPage.css" rel="stylesheet"/>
	<link type="text/css" href="css/bootstrap-tagsinput.css" rel="stylesheet"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div id="fullpage">
    <div class="section " id="connect">
        <h1>Give us your Spotify music collection. So we can ignore it.</h1>
        <p>We'll give you a playlist based on your tastes while banning artists you already have.</p>



        <div class="btn-group-login">
            <a href="/login/spotify" id="spotify-login" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-spotify">
                <i class="fa fa-spotify"></i>
            </a>
            <a href="#" disabled id="spotify-loggedin" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-spotify">
                <img class="media-object" src=""/>
            </a>
            <a id="spotify-logout" href="#">
                Sign out
            </a>
            <!--

            <a href="/login/lastfm" style="opacity: 0.3" id="lastfm-login" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-lastfm">
                <i class="fa fa-lastfm"></i>
            </a>

            <a href="#" style="opacity: 0.3" disabled="true" id="lastfm-loggedin" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-lastfm">
                <i class="fa fa-lastfm"></i>
            </a>
            -->
		</div>

		<div id='footer'>
			Powered by <a href="http://the.echonest.com" target="_blank">The Echo Nest</a> and <a href="http://spotify.com" target="_blank">Spotify</a>.
		</div>

        <div class="controls">
            <a class="next drop-in blink" style="display: none;" href="javascript:void(0);"><i class="fa fa-angle-down"></i></a>
        </div>

    </div>
	
	
	
    <div class ="section" id="seed">
        <h1>Choose at least 3 artists.</h1>
        <p>The playlist will have music that is similar to these artists but won't have their music.</p>
		<div class='centered'>
            <span>
                <input title="Artist" type="text"  size=34 id="artist" name="artist" value=''/>
            </span>
         </div>
		 <div class="controls">
			<a class="next drop-in blink" style="display: none;" href="javascript:void(0);"><i class="fa fa-angle-down"></i></a>
		</div>
    </div>
	
	<div class ="section" id="export">
        <h1>Generate a playlist.</h1>
        <p>You can start listening to it right away in Spotify.</p>

        <button class="btn btn-primary btn-lg btn-control btn-export" type="button" data-count="10">10</button>
		<button class="btn btn-primary btn-lg btn-control btn-export" type="button" data-count="20">20</button>
		<button class="btn btn-primary btn-lg btn-control btn-export" type="button" data-count="40">40</button>
		<button class="btn btn-primary btn-lg btn-control btn-export" type="button" data-count="50">50</button>

		 <div class="controls">
		</div>
    </div>
	
</div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="js/jquery.fullPage.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap-tagsinput.js"></script>
    <script src="js/q.js"></script>
    <script src="js/spotify-web-api.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        (function(SpotifyWebApi) {

			$('#fullpage').fullpage({
                autoScrolling:false,
				sectionsColor: ['rgb(245, 250, 250)', 'rgb(245, 250, 250)', 'rgb(245, 250, 250)', 'rgb(245, 250, 250)'],
					//equivalent to jQuery `easeOutBack` extracted from http://matthewlein.com/ceaser/
					//easingcss3: 'cubic-bezier(0.175, 0.885, 0.320, 1.275)'
					keyboardScrolling: false,
                    responsive: 1,
                    scrollOverflow: true,
                    afterSlideLoad: function( anchorLink, index, slideAnchor, slideIndex){
                        var loadedSlide = $(this);

                        //Seed loaded
                        if(anchorLink == 'seed' && slideIndex == 1){
                            alert("First slide loaded");
                            //$seeds.tagsinput('focus');
                            $(".bootstrap-tagsinput input:first").focus();
                        }

                    }
				});

            // Tab navigation breaks the web app. Need to disable it.
            $(document).keydown(function(objEvent) {
                if (objEvent.keyCode == 9) {  //tab pressed
                    objEvent.preventDefault(); // stops its action
                }
            });

            var artistsSeeded = {};
            $seeds = $('#artist');




            // Controlled input through tags.
            $seeds.tagsinput({
                trimValue: true,
                maxTags: 10,
                confirmKeys: [13, 44, 9]
            });

            // Control progress to next step based on how many artists are chosen.
            $seeds.on('itemAdded itemRemoved', function(event) {
                var numTags = $seeds.tagsinput('items').length;
                if(numTags >= 3){
                    $('#seed .controls > .next').show();
                } else {
                    $('#seed .controls > .next').hide();
                }
            });

            // Progress from Connect to Seed
			$("#fullpage #connect.section .next").click(function(){
				$.fn.fullpage.moveSectionDown();

                // Auto complete initialize in seed field.
                $(".bootstrap-tagsinput input").autocomplete({
                    source: function( request, response ) {
                        $.ajax({
                            url: config.echoNestHost + "api/v4/artist/suggest",
                            dataType: "jsonp",
                            data: {
                                results: 12,
                                'api_key': config.apiKey,
                                '_': Math.floor(Date.now()),
                                format:"jsonp",
                                name:request.term
                            },
                            success: function( data ) {
                                response( $.map( data.response.artists, function(item) {
                                    return {
                                        label: item.name,
                                        value: item.name,
                                        id: item.id
                                    }
                                }));
                            }
                        });
                    },
                    minLength: 3,
                    select: function( event, ui ) {
                        // We have remember these in order to remove them from the export playlist later.
                        if(ui.item){
                            artistsSeeded[ui.item.id] = ui.item.label;
                        }
                    }
                });
			});

            // Progress from Seed to Export
			$("#fullpage #seed.section .next").click(function(){
				$.fn.fullpage.moveSectionDown();
                createTasteProfile($("#artist").val());
			});

			
            var tasteProfile = {
                    current: null
                },
                user = {
                    spotifyId: null,
                    accessToken: null,
                    refreshToken: null
                },
                sessionId = null,
                spotify = new SpotifyWebApi();

            /* Unique keys to artist data */
            window.artists = {};

            spotify.setPromiseImplementation(Q);

            spotify.loadArtistsFromPlaylists = function(userId) {

                var pageReqs = [];

                var firstReq = spotify.getUserPlaylists(userId, {
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getUserPlaylists(userId, {
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var playlists = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlists', playlists);
                        for(var iItem = 0; iItem < playlists.length; iItem++){
                            spotify.loadArtistsFromPlaylistItem(userId, playlists[iItem]);
                        }
                    },function(err){

                    });

                });
            };

            spotify.loadArtistsFromPlaylistItem = function(userId, playlistItem){

                var pageReqs = [],
                    firstReq = spotify.getPlaylistTracks(userId, playlistItem.id, {
                        limit: 50
                    });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getPlaylistTracks(userId, playlistItem.id, {
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlist(' + playlistItem.name + ') tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromLibrary = function() {
                var pageReqs = [];

                var firstReq = spotify.getMySavedTracks({
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getMySavedTracks({
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all library tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromTrackItemList = function (trackItems){
                for(var iItem = 0; iItem < trackItems.length; iItem++){
                    spotify.loadArtistsFromTrackItem(trackItems[iItem]);
                }
            };

            spotify.loadArtistsFromTrackItem = function(trackItem){
                for(var iArtist = 0; iArtist < trackItem.track.artists.length; iArtist++){
                    var artistId = trackItem.track.artists[iArtist].id;
                    artists[artistId] = trackItem.track.artists[iArtist];
                }
            };

            var checkTasteProfileStatus = function(ticket){
                $.getJSON(config.echoNestHost + 'api/v4/tasteprofile/status',{
                    'api_key': config.apiKey,
                    'ticket': ticket,
                    '_': Math.floor(Date.now())
                }).done(function(data){
                    console.log(data);
                    if(data.response.ticket_status !== 'pending'){
                        return;
                    } else {
                        checkTasteProfileStatus(ticket);
                    }
                });
            };

            var createTasteProfile = function(artistsCommaDelim) {


                var tasteCreateUrl = config.echoNestHost + 'api/v4/tasteprofile/create';
                $.post(tasteCreateUrl, {
                    'api_key': config.apiKey,
                    'type':'general',
                    'name': Math.floor(Date.now()),
                    '_': Math.floor(Date.now())
                })
                .done(function(data) {
                    tasteProfile.current = data.response;

                    /*var seededArtists = artistsCommaDelim.split(',').map(function(name){
                        var seed = findArtist(name);
                        console.log("that seed!", seed);
                        if(seed){
                            console.log("before", Object.keys(artists).length);
                            var a = artists[seed.id];
                            delete artists[seed.id];
                            console.log("after", Object.keys(artists).length);
                            return a;
                        }
                    });*/

                    var favoritedArtists = artistsCommaDelim.split(',').map(function(name){
                        return {
                            'action': 'update',
                            'item': {
                                item_id: ++counter + '-' + name,
                                'artist_name': name,
                                'favorite': true
                            }
                        }
                    });

                    console.log("the seeded guys", favoritedArtists);
                    console.log("totally after", Object.keys(artists).length);

                    var counter = -1;
                    var tasteItems = Object.keys(artists).map(function(artistKeyAndId){
                        return {
                            action: 'update',
                            item: {
                                item_id: ++counter + '-' + artists[artistKeyAndId].name,
                                artist_id: 'spotify:artist:' + artistKeyAndId,
                                banned: true
                            }
                        };
                    })
                    .concat(favoritedArtists);

                    console.log(tasteItems);


                    var tasteUpdateUrl = config.echoNestHost + 'api/v4/tasteprofile/update?';
                    $.post(tasteUpdateUrl, {
                        'api_key': config.apiKey,
                        'id': tasteProfile.current.id,
                        'data': JSON.stringify(tasteItems),
                        '_': Math.floor(Date.now())
                    })
                    .done(function(data) {

                        checkTasteProfileStatus(data.response.ticket);

                        console.log("tasteprofile updated with banned artists", data);

                    })
                    .error( function() {
                        alert("Whoops, had some trouble getting that playlist");
                    });
                });

            };

            var createSpotifyPlaylist = function() {
                return spotify.createPlaylist(user.spotifyId, {
                    name: "Fuck What You Heard: The " + $("#artist").tagsinput('items').join(", ") + " Edition",
                    public: true
                }).then(function(playlist){
                    console.log('spotify playlist created', playlist);
                    return playlist;
                });
            };

            var createStaticEchonestPlaylist = function(count){
                var staticPlaylistCreateUrl = config.echoNestHost + 'api/v4/playlist/static';
                return $.get(staticPlaylistCreateUrl, {
                    'api_key': config.apiKey,
                    'type':'catalog-radio',
                    'variety': 1,
                    'distribution': 'wandering',
                    'adventurousness': 1,
                    'seed_catalog': tasteProfile.current.id,
                    'results': count + 10, // Margin of error for bad tracks, and filtering out seed artists
                    'bucket': [ 'id:' + config.spotifySpace, 'tracks'],
                    '_': Math.floor(Date.now()  )
                }).then(function(playlist){
                    return playlist;
                })
            };

            var createSrcDestPlaylists = function(count){
                return Q.all([
                    createSpotifyPlaylist(),         // Request #2
                    createStaticEchonestPlaylist(count)         // Request #3
                ]).spread(function(spPlaylist, enPlaylist){

                    console.log('mmmm spread', spPlaylist, enPlaylist);
                    return {
                        id: spPlaylist.id,
                        tracks: enPlaylist.response.songs.filter(function(song){
                            var isSeedArtist = typeof artistsSeeded[song.artist_id] !== "undefined";
                            return !isSeedArtist && ( song.tracks || song.tracks.length > 0 );
                        }).map(function(song){
                            return song.tracks;
                        }).map(function(trackList){
                            var firstValidTrackUri = null;
                            for( var iTrack = 0; iTrack < trackList.length; iTrack++){
                                if(trackList[iTrack].foreign_id){
                                    firstValidTrackUri = trackList[iTrack].foreign_id;
                                    break;
                                }
                            }
                            return firstValidTrackUri;
                        }).filter(function(uri){
                            return uri;
                        }).slice(0, 1 + count) // We asked for more than we needed
                    };
                });
            };

            var addTracksToSpotifyPlaylist = function(exportedPlaylist){
                return spotify.addTracksToPlaylist(user.spotifyId, exportedPlaylist.id, exportedPlaylist.tracks);
            };

            var generatePlaylist = function(count){

                createSrcDestPlaylists(count)
                    .then(addTracksToSpotifyPlaylist)
                    .then(function(response){
                        alert("done!");
                    });

            };

            var getHashParams = function() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                        q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            };

            $(document).ready(function() {
                var params = getHashParams();
                user.accessToken = params.access_token;
                user.refreshToken = params.refresh_token;
                var error = params.error;

                if (error) {
                    alert('There was an error during the authentication');
                } else {
                    if (user.accessToken) {
                        //user.refreshToken
                        $('#spotify-login').addClass('loading').attr('disabled',true);
                        spotify.setAccessToken(user.accessToken);
                        spotify.loadArtistsFromLibrary();
                        spotify.getMe().then(function(response){

                            user.spotifyId = response.id;

                            console.log("response from .getMe", response);

                            if(response.images.length !== 0){
                                $('#spotify-loggedin img').attr("src", response.images[0].url);

                            } else {
                                $('#spotify-loggedin img').attr("src", "images/default-avatar.png");
                            }

                            $('#spotify-loggedin img').load(function(){
                                $('#spotify-login').removeClass('loading').hide().attr('disabled',false);
                                $('#spotify-loggedin').css('display', 'inline-block');
                                $('#spotify-logout').show();
                            });

							$('#connect .controls > .next').show();

                            spotify.loadArtistsFromPlaylists(response.id);
                        })

                    } else {
                        // render initial screen
                        $('#spotify-login').css('display', 'inline-block');
                        $('#spotify-loggedin').hide();
                        $('#spotify-logout').hide();
                    }

                }

                $('#spotify-logout').click(function(){
                    $('#spotify-login').show().removeClass('loading').attr('disabled',false);
                    $('#spotify-loggedin').hide();
                    $('#spotify-logout').hide();
                    $('#connect .controls > .next').hide();
                });

                // Export playlists
                $(".btn-export").on("click", function(){
                    var trackCount = $(this).data("count");
                    if(trackCount > 0 && trackCount <= 50 ){
                        $(".btn-export").addClass("disabled");
                        //TODO static playlist creation logic goes here
                        generatePlaylist(trackCount);
                    }
                });




            });


        })(SpotifyWebApi);
    </script>

</body>
</html>
ÿ