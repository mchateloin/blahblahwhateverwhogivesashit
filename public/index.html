<!doctype html>
<html>
<head>
    <title>Music streaming thing</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/flatly/bootstrap.min.css" rel="stylesheet">
    <link type="text/css" href="css/styles.css" rel="stylesheet" />
</head>

<body>

    <div class="container">
        <div id="login">
            <h1></h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>
        <div id="loggedin">
            <div id="user-profile">
            </div>
            <div id="oauth">
            </div>
        </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
        <h1>Logged in as {{display_name}}</h1>
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
            </div>
        </div>

        <div class='container font-light'>
            <div id='content' class="col-md-offset-2 col-md-8">
                <div id='seed' class='centered'>
            <span> Seed artist:
                <input title="Artist" type="text"  size=34 id="artist" name="artist" value='Daft Punk,Kavinsky,Justice'/>
            </span>
                    <button class="btn btn-sm" value="go" id="go" name="go"> Go </button>
                </div>
                <div id="info"> </div>
                <div id="all_results"> </div>
                <div id='footer'>
                    Powered by <a href="http://the.echonest.com">The Echo Nest</a> and <a href="http://spotify.com">Spotify</a>.
                </div>
            </div>
        </div>
    </script>


    <script id="oauth-template" type="text/x-handlebars-template"></script>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/q.js"></script>
    <script src="js/spotify-web-api.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/spotify-echonest-tools.js"></script>
    <script>
        (function(SpotifyWebApi) {

            window.currPlayer = null;

            window.tasteProfile = {
                current: null
            };

            window.user = {
                accessToken: null,
                refreshToken: null
            };

            window.sessionId = null;

            /* Unique keys to artist data */
            window.artists = {};
            window.spotify = new SpotifyWebApi();
            spotify.setPromiseImplementation(Q);

            spotify.loadArtistsFromPlaylists = function(userId) {

                var pageReqs = [];

                var firstReq = spotify.getUserPlaylists(userId, {
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getUserPlaylists(userId, {
                            limit: limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var playlists = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlists', playlists);
                        for(var iItem = 0; iItem < playlists.length; iItem++){
                            spotify.loadArtistsFromPlaylistItem(userId, playlists[iItem]);
                        }
                    },function(err){

                    });

                });
            };

            spotify.loadArtistsFromPlaylistItem = function(userId, playlistItem){

                var pageReqs = [],
                    firstReq = spotify.getPlaylistTracks(userId, playlistItem.id, {
                        limit: 50
                    });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getPlaylistTracks(userId, playlistItem.id, {
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlist(' + playlistItem.name + ') tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromLibrary = function() {
                var pageReqs = [];

                var firstReq = spotify.getMySavedTracks({
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getMySavedTracks({
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all library tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromTrackItemList = function (trackItems){
                for(var iItem = 0; iItem < trackItems.length; iItem++){
                    spotify.loadArtistsFromTrackItem(trackItems[iItem]);
                }
            };

            spotify.loadArtistsFromTrackItem = function(trackItem){
                for(var iArtist = 0; iArtist < trackItem.track.artists.length; iArtist++){
                    var artistId = trackItem.track.artists[iArtist].id;
                    artists[artistId] = trackItem.track.artists[iArtist];
                }
            };

            function fetchArtistPlaylist(artist,  wandering, variety) {

                var counter = -1;
                var url = config.echoNestHost + 'api/v4/tasteprofile/create';
                info("Analyzing your tastes...");
                $.post(url, {
                    'api_key': config.apiKey,
                    'type':'general',
                    'name': Math.floor(Date.now())
                })
                .done(function(data) {
                    tasteProfile.current = data.response;

                            var seededArtists = artist.split(',').map(function(name){
                                var seed = findArtist(name);
                                console.log("that seed!", seed);
                                if(seed){
                                    console.log("before", Object.keys(artists).length);
                                    var a = artists[seed.id];
                                    delete artists[seed.id];
                                    console.log("after", Object.keys(artists).length);
                                    return a;
                                }
                            });

                            var favoritedArtists = artist.split(',').map(function(name){
                                return {
                                    'action': 'update',
                                    'item': {
                                        item_id: ++counter + '-' + name,
                                        'artist_name': name,
                                        'favorite': true
                                    }
                                }
                            });

                            console.log("the seeded guys", favoritedArtists);
                            console.log("totally after", Object.keys(artists).length);

                            var tasteItems = Object.keys(artists).map(function(artistKeyAndId){
                                return {
                                    action: 'update',
                                    item: {
                                        item_id: ++counter + '-' + artists[artistKeyAndId].name,
                                        artist_id: 'spotify:artist:' + artistKeyAndId,
                                        banned: true
                                    }
                                };
                            })
                            .concat(favoritedArtists);

                            var checkStatus = function(ticket){
                                $.getJSON(config.echoNestHost + 'api/v4/tasteprofile/status',{
                                    'api_key': config.apiKey,
                                    'ticket': ticket,
                                    '_': Math.floor(Date.now())
                                }).done(function(data){
                                    console.log(data);
                                   if(data.response.ticket_status !== 'pending'){
                                       setupPlayer();
                                   } else {
                                       checkStatus(ticket);
                                   }
                                });
                            };

                            var setupPlayer = function(){
                                var url = config.echoNestHost + 'api/v4/playlist/dynamic/create';
                                $("#all_results").empty();
                                info("Creating the playlist ...");
                                $.getJSON(url, {
                                    'seed_catalog': tasteProfile.current.id,
                                    'session_catalog': tasteProfile.current.id,
                                    'api_key': config.apiKey,
                                    'bucket': [ 'id:' + config.spotifySpace, 'tracks'],
                                    'variety' : 1,
                                    'adventurousness': 1,
                                    results: 0,
                                    'type':'catalog-radio'
                                })
                                        .done(function(data) {
                                            info("");
                                            sessionId = data.response.session_id;
                                            var title = "Artist radio for " + artist;
                                            getSpotifyPlayer(sessionId, seededArtists, function(player) {
                                                console.log('got the player');
                                                currPlayer = player;
                                                $("#all_results").append(player);
                                                console.log(player);
                                            });
                                        })
                                        .error( function() {
                                            info("Whoops, had some trouble getting that playlist");
                                        }) ;
                            };

                            console.log(tasteItems);


                            var tasteUpdateUrl = config.echoNestHost + 'api/v4/tasteprofile/update?';
                            $.post(tasteUpdateUrl, {
                                'api_key': config.apiKey,
                                'id': tasteProfile.current.id,
                                'data': JSON.stringify(tasteItems)
                            })
                            .done(function(data) {

                                checkStatus(data.response.ticket);

                                console.log("tasteprofile updated with banned artists", data);


                            })
                            .error( function() {
                                info("Whoops, had some trouble getting that playlist");
                            }) ;
                });

            }

            function newArtist() {
                var artist = $("#artist").val();
                fetchArtistPlaylist(artist, false, .2);
            }

            function info(txt) {
                $("#info").text(txt);
            }

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                        q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }




            $(document).ready(function() {

                var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                        userProfileTemplate = Handlebars.compile(userProfileSource),
                        userProfilePlaceholder = document.getElementById('user-profile');

                var params = getHashParams();
                user.accessToken = params.access_token;
                user.refreshToken = params.refresh_token;
                var error = params.error;

                if (error) {
                    alert('There was an error during the authentication');
                } else {
                    if (user.accessToken) {
                        //user.refreshToken

                        spotify.setAccessToken(user.accessToken);
                        spotify.loadArtistsFromLibrary();
                        spotify.getMe().then(function(response){
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                            $("#artist").on('keydown', function(evt) {
                                if (evt.keyCode == 13) {
                                    newArtist();
                                }
                            });

                            $("#go").on("click", function() {
                                newArtist();
                            });

                            $('#login').hide();
                            $('#loggedin').show();


                            spotify.loadArtistsFromPlaylists(response.id);
                        })

                    } else {
                        // render initial screen
                        $('#login').show();
                        $('#loggedin').hide();
                    }

                }


            });


        })(SpotifyWebApi);
    </script>

</body>
</html>

