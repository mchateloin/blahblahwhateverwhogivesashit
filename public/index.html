<!doctype html>
<html>
<head>
    <title>Music streaming thing</title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link type="text/css" href="http://netdna.bootstrapcdn.com/bootswatch/3.1.1/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,100italic,300italic,900italic,900,700italic,700,500italic,500,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/bootstrap-social-icons.css">
    <link type="text/css" href="css/font-awesome.min.css" rel="stylesheet" />
    <link type="text/css" href="css/styles.css" rel="stylesheet" />
    <link type="text/css" href="css/jquery.fullPage.css" rel="stylesheet"/>
</head>
<body>

<div id="fullpage">
    <div class="section " id="connect">
        <h1>Give us your entire music collection. So we can ignore it.</h1>
        <p>We'll give you a playlist based on your tastes while banning artists you. Go on, adventure awaits.</p>

        <a href="/login" id="spotify-login" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-spotify">
            <i class="fa fa-spotify"></i>
        </a>
        <a href="#" disabled id="spotify-loggedin" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-spotify">
            <img class="media-object" src=""/>
        </a>

        <a href="#" style="opacity: 0.3" disabled="true" id="lastfm-login" class="btn azm-social azm-size-64 azm-circle azm-long-shadow azm-lastfm">
            <i class="fa fa-lastfm"></i>
        </a>
        <div class=".controls">
            <a class="next" href="#seed"><i class="fa fa-angle-down"></i></a>
        </div>

    </div>
    <div class ="section" id="seed">
        asfsafsafasfasf
    </div>
</div>

    <script id="user-profile-template" type="text/x-handlebars-template">

        <div class='container font-light'>
            <div id='content' class="col-md-offset-2 col-md-8">
                <div id='seed' class='centered'>
            <span> Seed artist:
                <input title="Artist" type="text"  size=34 id="artist" name="artist" value='Daft Punk,Kavinsky,Justice'/>
            </span>
                    <button class="btn btn-sm" value="go" id="go" name="go"> Go </button>
                </div>
                <div id="info"> </div>
                <div id="all_results"> </div>
                <a href="javascript:void(0)" class="btn btn-primary export spotify" style="display: none;">Export to Spotify</a>
                <div id='footer'>
                    Powered by <a href="http://the.echonest.com">The Echo Nest</a> and <a href="http://spotify.com">Spotify</a>.
                </div>
            </div>
        </div>
    </script>


    <script id="oauth-template" type="text/x-handlebars-template"></script>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/q.js"></script>
    <script src="js/spotify-web-api.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/spotify-echonest-tools.js"></script>
    <script>
        (function(SpotifyWebApi) {

            var currPlayer = null,
                tasteProfile = {
                    current: null
                },
                user = {
                    accessToken: null,
                    refreshToken: null
                },
                sessionId = null,
                spotify = new SpotifyWebApi();

            /* Unique keys to artist data */
            window.artists = {};

            spotify.setPromiseImplementation(Q);

            spotify.createPlaylistFromRadio = function(userId){
                spotify.createPlaylist(userId, {
                    name: Math.floor(Date.now())
                }).then(function(playlist){
                    currPlayer.getDynamicPlaylistUpTo(40, function(exportedSongs){
                        console.log("all right let's add tracks!");
                        spotify.addTracksToPlaylist(userId, playlist.id, exportedSongs.map(function(s){
                            return s.spotifyTrackInfo.uri;
                        })).then(function(data){
                            alert("Done!");
                        });
                    });
                });
            };

            spotify.loadArtistsFromPlaylists = function(userId) {

                var pageReqs = [];

                var firstReq = spotify.getUserPlaylists(userId, {
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getUserPlaylists(userId, {
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var playlists = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlists', playlists);
                        for(var iItem = 0; iItem < playlists.length; iItem++){
                            spotify.loadArtistsFromPlaylistItem(userId, playlists[iItem]);
                        }
                    },function(err){

                    });

                });
            };

            spotify.loadArtistsFromPlaylistItem = function(userId, playlistItem){

                var pageReqs = [],
                    firstReq = spotify.getPlaylistTracks(userId, playlistItem.id, {
                        limit: 50
                    });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getPlaylistTracks(userId, playlistItem.id, {
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all playlist(' + playlistItem.name + ') tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromLibrary = function() {
                var pageReqs = [];

                var firstReq = spotify.getMySavedTracks({
                    limit: 50
                });

                pageReqs.push(firstReq);

                firstReq.done(function (firstPage) {
                    for (var offset = firstPage.limit; offset < firstPage.total; offset += firstPage.limit) {
                        pageReqs.push(spotify.getMySavedTracks({
                            limit: firstPage.limit,
                            offset: offset
                        }));
                    }

                    Q.all(pageReqs).done(function(data){
                        var tracks = [].concat.apply([], data.map(function(resp){
                            return resp.items;
                        }));
                        console.log('all library tracks', tracks);
                        spotify.loadArtistsFromTrackItemList(tracks);
                    },function(err){

                    });

                });

            };

            spotify.loadArtistsFromTrackItemList = function (trackItems){
                for(var iItem = 0; iItem < trackItems.length; iItem++){
                    spotify.loadArtistsFromTrackItem(trackItems[iItem]);
                }
            };

            spotify.loadArtistsFromTrackItem = function(trackItem){
                for(var iArtist = 0; iArtist < trackItem.track.artists.length; iArtist++){
                    var artistId = trackItem.track.artists[iArtist].id;
                    artists[artistId] = trackItem.track.artists[iArtist];
                }
            };

            function fetchArtistPlaylist(artist,  wandering, variety) {

                var counter = -1;
                var url = config.echoNestHost + 'api/v4/tasteprofile/create';
                info("Analyzing your tastes...");
                $.post(url, {
                    'api_key': config.apiKey,
                    'type':'general',
                    'name': Math.floor(Date.now())
                })
                .done(function(data) {
                    tasteProfile.current = data.response;

                            var seededArtists = artist.split(',').map(function(name){
                                var seed = findArtist(name);
                                console.log("that seed!", seed);
                                if(seed){
                                    console.log("before", Object.keys(artists).length);
                                    var a = artists[seed.id];
                                    delete artists[seed.id];
                                    console.log("after", Object.keys(artists).length);
                                    return a;
                                }
                            });

                            var favoritedArtists = artist.split(',').map(function(name){
                                return {
                                    'action': 'update',
                                    'item': {
                                        item_id: ++counter + '-' + name,
                                        'artist_name': name,
                                        'favorite': true
                                    }
                                }
                            });

                            console.log("the seeded guys", favoritedArtists);
                            console.log("totally after", Object.keys(artists).length);

                            var tasteItems = Object.keys(artists).map(function(artistKeyAndId){
                                return {
                                    action: 'update',
                                    item: {
                                        item_id: ++counter + '-' + artists[artistKeyAndId].name,
                                        artist_id: 'spotify:artist:' + artistKeyAndId,
                                        banned: true
                                    }
                                };
                            })
                            .concat(favoritedArtists);

                            var checkStatus = function(ticket){
                                $.getJSON(config.echoNestHost + 'api/v4/tasteprofile/status',{
                                    'api_key': config.apiKey,
                                    'ticket': ticket,
                                    '_': Math.floor(Date.now())
                                }).done(function(data){
                                    console.log(data);
                                   if(data.response.ticket_status !== 'pending'){
                                       setupPlayer();
                                   } else {
                                       checkStatus(ticket);
                                   }
                                });
                            };

                            var setupPlayer = function(){
                                var url = config.echoNestHost + 'api/v4/playlist/dynamic/create';
                                $("#all_results").empty();
                                info("Creating the playlist ...");
                                $.getJSON(url, {
                                    'seed_catalog': tasteProfile.current.id,
                                    'session_catalog': tasteProfile.current.id,
                                    'api_key': config.apiKey,
                                    'bucket': [ 'id:' + config.spotifySpace, 'tracks'],
                                    'variety' : 1,
                                    'adventurousness': 1,
                                    'distribution': 'wandering',
                                    results: 0,
                                    'type':'catalog-radio'
                                })
                                .done(function(data) {
                                    info("");
                                    sessionId = data.response.session_id;
                                    var title = "Artist radio for " + artist;
                                    getSpotifyPlayer(sessionId, seededArtists, function(player) {
                                        console.log('got the player');
                                        currPlayer = player;
                                        $("#all_results").append(player);
                                        console.log(player);
                                        $(".export.spotify").show();
                                    });
                                })
                                .error( function() {
                                    info("Whoops, had some trouble getting that playlist");
                                }) ;
                            };

                            console.log(tasteItems);


                            var tasteUpdateUrl = config.echoNestHost + 'api/v4/tasteprofile/update?';
                            $.post(tasteUpdateUrl, {
                                'api_key': config.apiKey,
                                'id': tasteProfile.current.id,
                                'data': JSON.stringify(tasteItems)
                            })
                            .done(function(data) {

                                checkStatus(data.response.ticket);

                                console.log("tasteprofile updated with banned artists", data);


                            })
                            .error( function() {
                                info("Whoops, had some trouble getting that playlist");
                            }) ;
                });

            }

            function newArtist() {
                var artist = $("#artist").val();
                fetchArtistPlaylist(artist, false, .2);
            }

            function info(txt) {
                $("#info").text(txt);
            }

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                        q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            $(document).ready(function() {

                var params = getHashParams();
                user.accessToken = params.access_token;
                user.refreshToken = params.refresh_token;
                var error = params.error;

                if (error) {
                    alert('There was an error during the authentication');
                } else {
                    if (user.accessToken) {
                        //user.refreshToken

                        spotify.setAccessToken(user.accessToken);
                        spotify.loadArtistsFromLibrary();
                        spotify.getMe().then(function(response){

                            $("#artist").on('keydown', function(evt) {
                                if (evt.keyCode == 13) {
                                    newArtist();
                                }
                            });

                            $("#go").on("click", function() {
                                newArtist();
                            });

                            $(".export.spotify").on("click", function(){
                                spotify.createPlaylistFromRadio(response.id);
                            });

                            $('#spotify-loggedin').css('display', 'inline-block');
                            $('#spotify-loggedin img').attr("src", response.images[0].url);
                            $('#spotify-login').hide();




                            spotify.loadArtistsFromPlaylists(response.id);
                        })

                    } else {
                        // render initial screen
                        $('#spotify-login').css('display', 'inline-block');
                        $('#spotify-loggedin').hide();
                    }

                }


            });


        })(SpotifyWebApi);
    </script>

</body>
</html>

